<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ably Chat + Video</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:system-ui; background:#0f0f12; color:#e8e8ea; display:grid; grid-template-rows:56px 1fr; height:100vh; }
    header { display:flex; align-items:center; gap:12px; padding:8px 12px; background:#17171b; }
    header img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
    header .spacer { margin-left:auto; display:flex; gap:8px; }
    main { display:grid; grid-template-columns:280px 1fr; }
    aside { border-right:1px solid #26262b; padding:12px; background:#121216; overflow:auto; }
    aside .room { padding:8px; border-radius:8px; cursor:pointer; margin-bottom:6px; background:#151519; }
    aside .room.active { background:#1b1f2a; border:1px solid #2b3350; }
    section { display:grid; grid-template-rows:1fr auto; }
    #messages { padding:12px; overflow:auto; }
    .msg { margin-bottom:10px; }
    .meta { font-size:12px; color:#9aa0a6; }
    .bubble { background:#191b22; padding:8px 10px; border-radius:10px; margin-top:4px; max-width:70ch; }
    #composer { display:flex; gap:8px; padding:12px; border-top:1px solid #26262b; background:#121216; }
    input { flex:1; padding:10px; border-radius:8px; border:1px solid #2b2f3a; background:#0e0f13; color:#e8e8ea; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #32415f; background:#1a2440; color:#cfe0ff; cursor:pointer; }
    #videoPanel { position:fixed; bottom:12px; right:12px; background:#0c0c10; border:1px solid #2a2a32; border-radius:10px; padding:8px; display:none; }
    video { width:240px; height:180px; background:#000; border-radius:8px; display:block; margin-bottom:6px; }
  </style>
</head>
<body>
  <header>
    <img id="avatar" src="" alt="avatar">
    <strong id="username">Guest</strong>
    <span id="clientId"></span>
    <div class="spacer">
      <button id="editProfile">Edit profile</button>
      <button id="newRoom">+ Room</button>
      <button id="startVideo">Start video</button>
      <button id="endVideo">End video</button>
    </div>
  </header>
  <main>
    <aside>
      <h3>Rooms</h3>
      <div id="rooms"></div>
    </aside>
    <section>
      <div id="messages"></div>
      <div id="composer">
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </section>
  </main>
  <div id="videoPanel">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <!-- Ably SDK -->
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
  <script>
    const ABLY_API_KEY = 'LDnKDA.DtVPsw:PjiwB3ql-g2U5YLAnyWo4Gv4PF1rQXnNDSpX1ApUm40';
    const DEFAULT_ROOM_ID = 'general';
    const STUN_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];

    const state = { ably:null, channels:new Map(), currentRoomId:DEFAULT_ROOM_ID, username:'', photoURL:'', clientId:'', pc:null, localStream:null, rtcChannel:null };

    const el = {
      username:document.getElementById('username'),
      avatar:document.getElementById('avatar'),
      clientId:document.getElementById('clientId'),
      rooms:document.getElementById('rooms'),
      messages:document.getElementById('messages'),
      input:document.getElementById('messageInput'),
      send:document.getElementById('sendBtn'),
      newRoom:document.getElementById('newRoom'),
      editProfile:document.getElementById('editProfile'),
      startVideo:document.getElementById('startVideo'),
      endVideo:document.getElementById('endVideo'),
      videoPanel:document.getElementById('videoPanel'),
      localVideo:document.getElementById('localVideo'),
      remoteVideo:document.getElementById('remoteVideo')
    };

    function initProfile() {
      const saved = JSON.parse(localStorage.getItem('profile')||'{}');
      state.username = saved.username || prompt('Choose a username:') || 'Guest';
      state.photoURL = saved.photoURL || '';
      state.clientId = saved.clientId || ('u_'+Math.random().toString(36).slice(2,10));
      localStorage.setItem('profile', JSON.stringify({username:state.username, photoURL:state.photoURL, clientId:state.clientId}));
      el.username.textContent = state.username;
      el.clientId.textContent = '('+state.clientId+')';
      el.avatar.src = state.photoURL || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23222"/></svg>';
    }

    async function initAbly() {
      state.ably = new Ably.Realtime({ key: ABLY_API_KEY, clientId: state.clientId });
      await new Promise(res => state.ably.connection.once('connected', res));
      renderRooms([DEFAULT_ROOM_ID]);
      await switchRoom(DEFAULT_ROOM_ID);
    }

    function getChannel(name) {
      if (!state.channels.has(name)) {
        state.channels.set(name, state.ably.channels.get(name));
      }
      return state.channels.get(name);
    }

    async function switchRoom(roomId) {
      state.currentRoomId = roomId;
      const chatCh = getChannel('chat:'+roomId);
      el.messages.innerHTML = '';

      // Load history
      chatCh.history({ limit:50 }, (err,page) => {
        if (err) { console.error(err); return; }
        page.items.reverse().forEach(msg => {
          const { text, user, ts } = msg.data;
          addMessage(user,text,ts);
        });
      });

      // Subscribe to new
      chatCh.subscribe('chat', msg => {
        const { text, user, ts } = msg.data;
        addMessage(user,text,ts);
      });

      // Video signaling channel
      state.rtcChannel = getChannel('rtc:'+roomId);
      state.rtcChannel.subscribe('offer', async msg => {
        if (msg.clientId===state.clientId) return;
        await ensurePeerConnection();
        await state.pc.setRemoteDescription(new RTCSessionDescription(msg.data));
        const answer = await state.pc.createAnswer();
        await state.pc.setLocalDescription(answer);
        state.rtcChannel.publish('answer', answer);
      });
      state.rtcChannel.subscribe('answer', async msg => {
        if (msg.clientId===state.clientId) return;
        if (!state.pc.currentRemoteDescription) {
          await state.pc.setRemoteDescription(new RTCSessionDescription(msg.data));
        }
      });
      state.rtcChannel.subscribe('ice', async msg => {
        if (msg.clientId===state.clientId) return;
        try { await state.pc.addIceCandidate(new RTCIceCandidate(msg.data)); } catch(e){ console.warn(e); }
      });
    }

    function renderRooms(ids) {
      el.rooms.innerHTML='';
      ids.forEach(id=>{
        const div=document.createElement('div');
        div.className='room';
        div.textContent=id===DEFAULT_ROOM_ID?'General':'Room: '+id;
        div.onclick=()=>switchRoom(id);
        el.rooms.appendChild(div);
      });
    }

    function addMessage(user,text,ts) {
      const wrap=document.createElement('div'); wrap.className='msg';
      const meta=document.createElement('div'); meta.className='meta';
      meta.textContent=(user.username||'Unknown')+' â€” '+new Date(ts||Date.now()).toLocaleTimeString();
      const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=text;
      wrap.appendChild(meta); wrap.appendChild(b
